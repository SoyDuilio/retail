<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Vendedor - Sistema Distribución</title>
    <link rel="stylesheet" href="/static/css/vendedor/ventas_externas.css?v=5">
</head>
<body>
    <!-- Header sticky con información del vendedor y pedido -->
    <header class="header-sticky">
        <div class="header-content">
            <div class="header-left">
                <div class="avatar-vendedor">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div class="vendedor-info">
                    <h1 id="vendedorNombre">Cargando...</h1>
                    <p id="vendedorCodigo">Vendedor</p>
                </div>
            </div>
            
            <!-- Información del pedido actual (ubicación y cliente) -->
            <div class="header-center" id="infoPedidoHeader">
                <!-- Botón de ubicación -->
                <button class="btn-ubicacion" id="btnUbicacion" onclick="mostrarModalUbicacion()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span id="estadoUbicacion">Sin ubicación</span>
                </button>
                
                <!-- Chip de cliente seleccionado (oculto inicialmente) -->
                <div class="chip-cliente hidden" id="chipCliente">
                    <div class="chip-content">
                        <span class="chip-nombre" id="chipClienteNombre"></span>
                        <span class="chip-tipo" id="chipClienteTipo"></span>
                    </div>
                    <button class="chip-close" onclick="cambiarCliente()">
                        <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="header-right">
                <div class="stats-compactas">
                    <div class="stat-item">
                        <p class="stat-valor" id="pedidosHoy">0</p>
                        <p class="stat-label">Pedidos</p>
                    </div>
                    <div class="stat-item">
                        <p class="stat-valor" id="ventasHoy">S/0</p>
                        <p class="stat-label">Ventas</p>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="container-main">
        <div class="seccion-busqueda-combinada">
            <div class="glass-card">
                <!-- Búsqueda dual (se oculta al seleccionar cliente) -->
                <div class="busqueda-dual">
                    <!-- Búsqueda de Cliente -->
                    <div class="input-wrapper">
                        <label class="input-label">Cliente</label>
                        <div class="input-group-compacto">
                            <input
                                type="text"
                                id="inputBusquedaCliente"
                                class="input-compacto"
                                placeholder="RUC o nombre..."
                                autocomplete="off"
                            >
                            <button class="btn-mic-compacto" id="micCliente" onclick="iniciarDictadoCliente()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                            <button class="btn-nuevo-cliente" onclick="abrirModalNuevoCliente()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="dropdown-resultados hidden" id="dropdownClientes"></div>
                    </div>

                    <!-- Placeholder para simetría -->
                    <div class="input-wrapper">
                        <label class="input-label">Producto</label>
                        <div class="input-placeholder">
                            <span>Selecciona un cliente primero</span>
                        </div>
                    </div>
                </div>

                <!-- Chip de cliente (visible después de seleccionar) -->
                <div class="chip-cliente hidden" id="chipCliente">
                    <div class="chip-content">
                        <span class="chip-nombre" id="chipClienteNombre"></span>
                        <span class="chip-tipo" id="chipClienteTipo"></span>
                    </div>
                    <button class="chip-close" onclick="cambiarCliente()">
                        <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Búsqueda de productos (SIEMPRE visible después de seleccionar cliente) -->
                <div class="busqueda-productos hidden" id="busquedaProductos">
                    <label class="input-label">Buscar Productos</label>
                    <div class="input-group-compacto">
                        <input
                            type="text"
                            id="inputProductos"
                            class="input-compacto"
                            placeholder="Código o nombre del producto..."
                            autocomplete="off"
                        >
                        <button class="btn-mic-compacto" id="micBrowser" onclick="toggleRecordingBrowser()" title="Micrófono del navegador">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </button>
                        <button class="btn-mic-compacto btn-mic-google" id="micGoogle" onclick="toggleRecordingGoogle()" title="Micrófono de Google">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="dropdown-productos hidden" id="dropdownProductos">
                        <div class="dropdown-productos-header">
                            <span id="countSeleccionados">0 seleccionados</span>
                            <button class="btn-agregar-productos hidden" id="btnAgregarProductos" onclick="agregarProductosSeleccionados()">
                                Agregar
                            </button>
                        </div>
                        <div class="dropdown-productos-lista" id="listaProductosDropdown"></div>
                    </div>
                </div>

                <!-- Indicador de procesamiento -->
                <div class="procesando hidden" id="procesandoProductos">
                    <div class="spinner"></div>
                    <span>Procesando pedido...</span>
                </div>
            </div>
        </div>

        <!-- Lista de productos del pedido -->
        <div class="productos-pedido hidden" id="productosContainer">
            <div class="glass-card">
                <div class="pedido-header">
                    <h3 class="pedido-titulo">Productos del Pedido</h3>
                    <button class="btn-limpiar" onclick="limpiarPedido()">Limpiar</button>
                </div>
                <div class="lista-productos" id="listaProductos"></div>
                <div class="pedido-footer">
                    <div class="total-pedido">
                        <span>Total:</span>
                        <span class="total-monto" id="totalPedido">S/ 0.00</span>
                    </div>
                    <button class="btn-confirmar-pedido" onclick="confirmarPedido()">
                        CONFIRMAR PEDIDO
                    </button>
                </div>
            </div>
        </div>

    <!-- Barra inferior con accesos rápidos -->
    <div class="barra-inferior">
        <button class="btn-estadistica" onclick="mostrarModalMeta()" title="Meta del día">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <span>Meta</span>
        </button>
        <button class="btn-estadistica" onclick="mostrarModalPedidos()" title="Pedidos del día">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <span>Pedidos</span>
        </button>
        <button class="btn-estadistica" onclick="mostrarModalRanking()" title="Ranking">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            <span>Ranking</span>
        </button>
        <button class="btn-estadistica" onclick="mostrarMenuMas()" title="Más opciones">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <span>Más</span>
        </button>
    </div>

    <!-- Modal de Ubicación -->
    <div class="modal-overlay hidden" id="modalUbicacion">
        <div class="modal-small">
            <div class="modal-header">
                <h3>Ubicación Actual</h3>
                <button class="btn-close-modal" onclick="cerrarModal('modalUbicacion')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="contenidoUbicacion">
                    <button class="btn-compartir-ubicacion" onclick="solicitarUbicacion()">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        </svg>
                        Compartir Ubicación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div class="modal-overlay hidden" id="modalNuevoCliente">
        <div class="modal-medium">
            <div class="modal-header">
                <h3>Registrar Nueva Bodega</h3>
                <button class="btn-close-modal" onclick="cerrarModal('modalNuevoCliente')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="formNuevoCliente" class="form-modal">
                    <div class="form-group">
                        <label>RUC</label>
                        <div class="input-with-validation">
                            <input type="text" id="nuevoRuc" maxlength="11" placeholder="20123456789" />
                            <div class="spinner-small hidden" id="validandoRuc"></div>
                        </div>
                        <div class="validation-message" id="resultadoValidacionRuc"></div>
                    </div>
                    <div class="form-group">
                        <label>Razón Social</label>
                        <input type="text" id="nuevaRazonSocial" placeholder="Se llenará automáticamente" readonly />
                    </div>
                    <div class="form-group">
                        <label>Nombre Comercial</label>
                        <input type="text" id="nuevoNombreComercial" placeholder="Bodega San Martín" />
                    </div>
                    <div class="form-group">
                        <label>Dirección Completa</label>
                        <input type="text" id="nuevaDireccion" placeholder="Jr. Los Rosales 123" />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Distrito</label>
                            <input type="text" id="nuevoDistrito" placeholder="Lima" />
                        </div>
                        <div class="form-group">
                            <label>Provincia</label>
                            <input type="text" id="nuevaProvincia" placeholder="Lima" />
                        </div>
                        <div class="form-group">
                            <label>Región</label>
                            <input type="text" id="nuevaRegion" placeholder="Lima" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Teléfono/WhatsApp</label>
                        <input type="tel" id="nuevoTelefono" placeholder="987654321" maxlength="9" />
                    </div>
                    <div class="form-group">
                        <label>Persona que hace el pedido</label>
                        <input type="text" id="personaPedido" placeholder="Juan Pérez (encargado)" />
                    </div>
                    <button type="button" class="btn-primary" onclick="registrarNuevoCliente()">
                        Registrar Bodega
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Pedido -->
    <div class="modal-overlay hidden" id="modalConfirmarPedido">
        <div class="modal-medium">
            <div class="modal-header">
                <h3>Confirmar Pedido</h3>
                <button class="btn-close-modal" onclick="cerrarModal('modalConfirmarPedido')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-modal">
                    <div class="form-group">
                        <label>Modalidad de Pago</label>
                        <select id="modalidadPago" class="select-pago">
                            <option value="efectivo_cash">Efectivo - CASH</option>
                            <option value="efectivo_yape">Efectivo - Yape</option>
                            <option value="efectivo_plin">Efectivo - Plin</option>
                            <option value="credito_15_dias" selected>Crédito 15 días</option>
                            <option value="credito_30_dias">Crédito 30 días</option>
                            <option value="credito_45_dias">Crédito 45 días</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observaciones (opcional)</label>
                        <textarea id="observacionesPedido" rows="3" placeholder="Comentarios adicionales"></textarea>
                    </div>
                    <div class="alert-coincidencia" id="alertCoincidencia"></div>
                    <button class="btn-primary" onclick="enviarPedidoFinal()">
                        ENVIAR PEDIDO
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Pedidos del Día -->
    <div class="modal-overlay hidden" id="modalPedidos">
        <div class="modal-large">
            <div class="modal-header">
                <h3>📦 Pedidos del Día</h3>
                <button class="btn-close-modal" onclick="cerrarModal('modalPedidos')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="stats-resumen">
                    <div class="stat-card">
                        <div class="stat-numero" id="totalPedidosHoy">0</div>
                        <div class="stat-titulo">Total Pedidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-numero" id="totalVentasHoy">S/ 0</div>
                        <div class="stat-titulo">Total Ventas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-numero" id="pendientesHoy">0</div>
                        <div class="stat-titulo">Pendientes</div>
                    </div>
                </div>
                
                <div id="listaPedidosHoy" class="lista-pedidos-modal">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Cargando pedidos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/vendedor/ventas_externas.js"></script>
</body>
</html>